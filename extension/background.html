<html>
	<script type="text/javascript" src="lastfm.api.md5.js"></script>
	<script type="text/javascript" src="lastfm.api.js"></script>
	<script type="text/javascript" src="jquery.min.js"></script>
	
	<script type="text/javascript" src="background-settings.js"></script>
	<script type="text/javascript" src="background-db.js"></script>
	<script type="text/javascript" src="lrdata-interface.js"></script>
	<script>
		////////////////////////////Enums
		
		var lastfmStatus = {
			SCROBBLING_DISABLED: -1,
			UNSENT: 0,
			PLAYING_SENT: 1,
			WAITING_FOR_SCROBBLING: 2,
			SCROBBLED: 3
		}
		
		var lastfmLovedStatus = {
			LOVE_SENT: 1,
			LOVE_ACKNOWLEDGED: 2
		}
		
		////////////////////////////
		
		var db = new Database();
		var currentTrack;
		var lastfm = new LastFM({
			apiKey    : 'c0db7c8bfb98655ab25aa2e959fdcc68',
			apiSecret : 'aff4890d7cb9492bc72250abbeffc3e1'
		});
		var lrdata = new LRDataInterface("lrdata.alnorth.com", 8080);
		var settings = new Settings(window.localStorage);
		var lastfmUsername;
		var lastfmPassword;
		var lastfmSession;
		var tabsForTracks = {};
		
		function urlEncodeCharacter(c) {
			return '%' + c.charCodeAt(0).toString(16);
		}

		function urlEncode(s) {
			return encodeURIComponent( s ).replace( /\%20/g, '+' ).replace( /[!'()*~]/g, urlEncodeCharacter );
		}
		
		function sendUpdatedTrackInfo(trackId) {
			getTrackInfo(trackId, false, function(info) {
				chrome.tabs.sendRequest(tabsForTracks[trackId], {type: "updatedtrackinfo", id: trackId, info: info}, function(response) {});
			});
		}
		
		function sendUpdatedCallback(trackId) {
			return function() {
				sendUpdatedTrackInfo(trackId);
			};
		}
		
		function getTrackInfo(trackId, fetchMissingData, callback) {
			db.getTrackInfo(trackId, sqlError, function(dbData) {
				if(dbData) {
					var info = {};
					var url = dbData["lastfm_url"];
					if ((!url || url == "") && fetchMissingData) {
						lastfm.track.getInfo({artist: dbData["artist"], track: dbData["title"]}, {success: function(data){
							db.saveLastfmUrl(trackId, data.track.url, sqlError, sendUpdatedCallback(trackId));
						}, error: function(code, message){
							var newUrl = "none";
							if(dbData["title"] != "") {
								newUrl = "http://www.last.fm/search?q=" + urlEncode(dbData["title"] + " - " + dbData["artist"]);
							}
							db.saveLastfmUrl(trackId, newUrl, sqlError, sendUpdatedCallback(trackId));
						}});
					} else {
						info.lastfmurl = url;
					}
					info.lastfmstatus = dbData["lastfm_status"];
					info.lastfmloved = (dbData["lastfm_loved"] == lastfmLovedStatus.LOVE_SENT || dbData["lastfm_loved"] == lastfmLovedStatus.LOVE_ACKNOWLEDGED);
					info.user = dbData["username"];
					info.userId = dbData["user_id"];
					
					callback(info);
				} else {
					callback(undefined);
				}
			});
		}
		
		function setTrackLoved(trackId, title, artist) {
			db.saveLovedStatus(trackId, lastfmLovedStatus.LOVE_SENT, sqlError, sendUpdatedCallback(trackId));
			
			if(settings.get("showlastfmlovebutton") && lastfmSession && title && artist) {
				lastfm.track.love({artist: artist, track: title}, lastfmSession, {
					success: function(data){
						db.saveLovedStatus(trackId, lastfmLovedStatus.LOVE_ACKNOWLEDGED, sqlError, sendUpdatedCallback(trackId));
					}, error: function(code, message){
						console.log("Last.fm loving error.");
					}
				});
			}
		}
		
		function setNowPlaying(track) {
			if(settings.get("scrobble") && lastfmSession && track.title && track.artist) {
				lastfm.track.updateNowPlaying({track: track.title, artist: track.artist, album: track.album}, lastfmSession);
				db.saveLastFmStatus(track.id, lastfmStatus.PLAYING_SENT, sqlError, ignore);
			}
		}
		
		function ignore() {}
		
		function sqlError(tx, error) {
			console.log("SQL error: " + error.message);
		}
		
		function processMessage(request, sender, sendResponse) {
			if(request.type == "addtracktodb") {
				tabsForTracks[request.track.id] = sender.tab.id;
				db.addTrackToDB(request.track, request.isCurrent, settings.get("senddata"), sqlError);
				
				if(request.isCurrent) {
					currentTrack = request.track;
					setNowPlaying(request.track);
					db.setPastTracksToScrobbleable(request.track.id, sqlError);
				}
				
				sendResponse({"id": request.id});
			} else if(request.type == "lastfmlogin") {
				lastFmLoginData(request.login);
				window.localStorage.setItem("lastfm_username", request.login.username);
				sendResponse({});
			} else if(request.type == "gethtml") {
				$.get(request.url, function(data) {
					sendResponse(data);
				});
			} else if(request.type == "savesettings") {
				saveSettingsToLocalStorage(request.settings);
				sendResponse({});
			} else if(request.type == "getsettings") {
				sendResponse(settings.toObject());
			} else if(request.type == "gettrackinfo") {
				getTrackInfo(request.id, true, function(info) {sendResponse(info);});
			} else if(request.type == "settrackloved") {
				setTrackLoved(request.id, request.title, request.artist);
				sendResponse({});
			} else if(request.type == "initroom") {
				initRoom(request.room);
				sendResponse({});
			}
		}
		
		function saveSettingsToLocalStorage(settingsData) {
			settings.fromObject(settingsData);
						
			if(!settings.get("scrobble") && !settings.get("showlastfmlovebutton") && lastfmSession) {
				lastfmSession = undefined;
			}
		}
		
		function initRoom(room) {
			// Update the USER table with users from this room.
			lrdata.getUsers(room, function(data) {
				for(var i = 0; i < data.length; i++) {
					db.setUserData(data[i].user_lr_id, data[i].username, sqlError, ignore);
				}
			});
		}
		
		function lastFmLoginData(login) {
			lastfmUsername = login.username;
						
			lastfm.auth.getMobileSession({username: lastfmUsername, password: login.password}, {success: function(data){
				lastfmSession = data.session;
				if(currentTrack) {
					setNowPlaying(currentTrack);
				}
			}, error: function(code, message){
				console.log("Last.fm log in error: " + code + " - " + message);
			}});
		}
		
		function showLastfmLoginBox() {
			if((settings.get("scrobble") || settings.get("showlastfmlovebutton")) && lastfmSession == undefined) {
				chrome.tabs.getSelected(null, function(tab) {
				  chrome.tabs.sendRequest(tab.id, {type: "lastfmloginneeded", lastfmUsername: lastfmUsername}, function(response) {});
				});
			}
		}
		
		function scrobbleOldestScrobbleableTrack() {
			if(settings.get("scrobble") && lastfmSession != undefined) {
				db.getOldestScrobbleableTrack(sqlError, function(dbData) {
					if(dbData) {
						var timestamp = Math.round(parseInt(dbData["date"]) / 1000);
						lastfm.track.scrobble({track: dbData["title"], timestamp: timestamp, artist: dbData["artist"], album: dbData["album"]}, lastfmSession, {success: function(data){
							db.saveLastFmStatus(dbData["id"], lastfmStatus.SCROBBLED, sqlError, sendUpdatedCallback(dbData["id"]));
						}, error: function(code, message){
							console.log("Last.fm scrobble error: " + code + " - " + message);
						}});
					}
				});
			}
		}
		
		function sendOldestUnsentData() {
			if(settings.get("senddata")) {
				db.getOldestUnsentData(sqlError, function(dbData) {
					if(dbData) {
						lrdata.sendTrackData(dbData, function(data) {
							db.saveLRDBData(dbData["id"], data, sqlError, ignore);
						});
					}
				});
			}
		}
		
		function pulse() {
			showLastfmLoginBox();
			scrobbleOldestScrobbleableTrack();
			sendOldestUnsentData();
		}
		
		function init() {
			chrome.extension.onRequest.addListener(processMessage);
			var storedLastfmUser = window.localStorage.getItem("lastfm_username");
			if(storedLastfmUser) {
				lastfmUsername = storedLastfmUser;
			}
			setInterval(pulse, 5000);
		}
		
		init();
	</script>
</html>

