<html>
	<script type="text/javascript" src="lastfm.api.md5.js"></script>
	<script type="text/javascript" src="lastfm.api.js"></script>
	<script type="text/javascript" src="jquery.min.js"></script>
	<script>
		////////////////////////////Enums
		
		var lastfmStatus = {
			SCROBBLING_DISABLED: -1,
			UNSENT: 0,
			PLAYING_SENT: 1,
			WAITING_FOR_SCROBBLING: 2,
			SCROBBLED: 3
		}
		
		var lastfmLovedStatus = {
			LOVE_SENT: 1,
			LOVE_ACKNOWLEDGED: 2
		}
		
		////////////////////////////
		
		var db = openDatabase("listeningroom-addons-data", "", "Listening Room Addons data", 1048576);
		var currentTrack;
		var lastfm = new LastFM({
			apiKey    : 'c0db7c8bfb98655ab25aa2e959fdcc68',
			apiSecret : 'aff4890d7cb9492bc72250abbeffc3e1'
		});
		var settings;
		var lastfmUsername;
		var lastfmPassword;
		var lastfmSession;
		var tabsForTracks = {};
		
		function initDB() {
			db.transaction(function(tx) {
				tx.executeSql('create table if not exists TRACK_PLAY ' +
					'(id text, artist text, title text, album text, filename text, user text, date int, lastfm_status int, lastfm_url text)', [], ignore, sqlError);
					
				tx.executeSql('create table if not exists DB_DATA(version int)', [], ignore, sqlError);
					
				tx.executeSql('SELECT version FROM DB_DATA', [], function(tx, rs) {
					if(rs.rows.length == 0) {
						updateDB(tx, 0);
					} else {
						updateDB(tx, rs.rows.item(0)["version"]);
					}
				}, sqlError);
				
				var now = (new Date()).getTime();
				var yesterday = now - 24*60*60*1000;
				tx.executeSql('delete from TRACK_PLAY where date < ? and lastfm_status <> ?', [yesterday, lastfmStatus.WAITING_FOR_SCROBBLING], ignore, sqlError);
			});
		}
		
		function updateDB(tx, currentVersion) {
			if(currentVersion == 0) {
				tx.executeSql('insert into DB_DATA(version) values (1)', [], ignore, sqlError);
				tx.executeSql('alter table TRACK_PLAY add column lastfm_loved int', [], ignore, sqlError);
				currentVersion = 1;
			}
			if(currentVersion == 1) {
				tx.executeSql('alter table TRACK_PLAY add column album_art text', [], ignore, sqlError);
				tx.executeSql('update DB_DATA set version = 2', [], ignore, sqlError);
				currentVersion = 2;
			}
		}
		
		function undefinedToBlank(val) {
			return val ? val : '';
		}
		
		function urlEncodeCharacter(c) {
			return '%' + c.charCodeAt(0).toString(16);
		}

		function urlEncode(s) {
			return encodeURIComponent( s ).replace( /\%20/g, '+' ).replace( /[!'()*~]/g, urlEncodeCharacter );
		}
		
		function addTrackToDB(trackData) {
			db.transaction(function(tx) {
				tx.executeSql('select count(*) as num from TRACK_PLAY where id = ?', [trackData.id], function(tx2, rs) {
						if(rs.rows.item(0)["num"] == 0) {
							tx2.executeSql('insert into TRACK_PLAY ' +
								'(id, artist, title, album, filename, user, date, lastfm_status, lastfm_url)' + 
								'values (?, ?, ?, ?, ?, ?, ?, ?, ?)',
								[trackData.id,
									undefinedToBlank(trackData.artist),
									undefinedToBlank(trackData.title),
									undefinedToBlank(trackData.album),
									trackData.filename,
									undefinedToBlank(trackData.user),
									(new Date()).getTime(),
									lastfmSession ? lastfmStatus.UNSENT : lastfmStatus.SCROBBLING_DISABLED,
									''
								],
								ignore, sqlError);
						}
					}, sqlError);
			});
		}
		
		function setPastTracksToScrobbleable() {
			db.transaction(function(tx) {
				tx.executeSql('update TRACK_PLAY set lastfm_status = ? where lastfm_status = ? and id <> ?', [lastfmStatus.WAITING_FOR_SCROBBLING, lastfmStatus.PLAYING_SENT, currentTrack.id], ignore, sqlError);
			});
		}
		
		function saveAlbumArt(trackId, url) {
			db.transaction(function(tx) {
				tx.executeSql('update TRACK_PLAY set album_art = ? where id = ?', [url, trackId], ignore, sqlError);
				sendUpdatedTrackInfo(trackId);
			});
		};
		
		function saveLastfmUrl(trackId, url) {
			db.transaction(function(tx) {
				tx.executeSql('update TRACK_PLAY set lastfm_url = ? where id = ?', [url, trackId], ignore, sqlError);
				sendUpdatedTrackInfo(trackId);
			});
		};
		
		function sendUpdatedTrackInfo(trackId) {
			getTrackInfo(trackId, false, function(info) {
				chrome.tabs.sendRequest(tabsForTracks[trackId], {type: "updatedtrackinfo", id: trackId, info: info}, function(response) {});
			});
		}
		
		function getTrackInfo(trackId, fetchMissingData, callback) {
			db.transaction(function(tx) {
				var info = {};
				tx.executeSql('select lastfm_status, lastfm_url, lastfm_loved, album_art, title, artist, album, user from TRACK_PLAY where id = ?', [trackId], function(tx, rs) {
					if(rs.rows.length == 1) {
						var albumArt = rs.rows.item(0)["album_art"];
						if((!albumArt || albumArt == "") && fetchMissingData) {
							lastfm.album.getInfo({artist: rs.rows.item(0)["artist"], album: rs.rows.item(0)["album"]}, {success: function(data){
								if(data && data.album && data.album.image) {
									var lastfmImageUrl;
									for(var i = data.album.image.length - 1; i >=0; i--) {
										if(lastfmImageUrl == undefined && data.album.image[i] != "") {
											lastfmImageUrl = data.album.image[i]["#text"];
										}
									}
									saveAlbumArt(trackId, lastfmImageUrl);
								}
							}, error: function(code, message){
								saveAlbumArt(trackId, "none");
							}});
						} else {
							info.albumArt = albumArt;
						}
						var url = rs.rows.item(0)["lastfm_url"];
						if ((!url || url == "") && fetchMissingData) {
							lastfm.track.getInfo({artist: rs.rows.item(0)["artist"], track: rs.rows.item(0)["title"]}, {success: function(data){
								saveLastfmUrl(trackId, data.track.url);
							}, error: function(code, message){
								if(rs.rows.item(0)["title"] != "") {
									saveLastfmUrl(trackId, "http://www.last.fm/search?q=" + urlEncode(rs.rows.item(0)["title"] + " - " + rs.rows.item(0)["artist"]));
								} else {
									saveLastfmUrl(trackId, "none");
								}
							}});
						} else {
							info.lastfmurl = url;
						}
						info.lastfmstatus = rs.rows.item(0)["lastfm_status"];
						info.lastfmloved = (rs.rows.item(0)["lastfm_loved"] == lastfmLovedStatus.LOVE_SENT || rs.rows.item(0)["lastfm_loved"] == lastfmLovedStatus.LOVE_ACKNOWLEDGED);
						info.user = rs.rows.item(0)["user"];
						
						callback(info);
					} else {
						callback(undefined);
					}
				}, sqlError);
			});
		}
		
		function saveLovedStatus(trackId, status) {
			db.transaction(function(tx) {
				tx.executeSql('update TRACK_PLAY set lastfm_loved = ? where id = ?', [status, trackId], ignore, sqlError);
				sendUpdatedTrackInfo(trackId);
			});
		}
		
		function setTrackLoved(trackId, title, artist) {
			saveLovedStatus(trackId, lastfmLovedStatus.LOVE_SENT);
			if(settings.showlastfmlovebutton && lastfmSession && title && artist) {
				lastfm.track.love({artist: artist, track: title}, lastfmSession, {success: function(data){
					saveLovedStatus(trackId, lastfmLovedStatus.LOVE_ACKNOWLEDGED);
				}, error: function(code, message){
					console.log("Last.fm loving error.");
				}});
			}
		}
		
		function setNowPlaying(track) {
			if(settings.scrobble && lastfmSession && track.title && track.artist) {
				lastfm.track.updateNowPlaying({track: track.title, artist: track.artist, album: track.album}, lastfmSession);
				db.transaction(function(tx) {
					tx.executeSql('update TRACK_PLAY set lastfm_status = ? where id = ?', [lastfmStatus.PLAYING_SENT, track.id], ignore, sqlError);
				});
			}
		}
		
		function ignore() {}
		
		function sqlError(tx, error) {
			console.log("SQL error: " + error.message);
		}
		
		function processMessage(request, sender, sendResponse) {
			if(request.type == "newtrack") {
				currentTrack = request.track;
				tabsForTracks[request.track.id] = sender.tab.id;
				
				setPastTracksToScrobbleable();
				addTrackToDB(request.track);
				setNowPlaying(request.track);
				
				sendResponse({"id": request.id});
			} else if(request.type == "lastfmlogin") {
				lastFmLoginData(request.login);
				window.localStorage.setItem("lastfm_username", request.login.username);
				sendResponse({});
			} else if(request.type == "gethtml") {
				$.get(request.url, function(data) {
					sendResponse(data);
				});
			} else if(request.type == "savesettings") {
				settings = request.settings;
				saveSettingsToLocalStorage();
				sendResponse({});
			} else if(request.type == "getsettings") {
				sendResponse(settings);
			} else if(request.type == "gettrackinfo") {
				getTrackInfo(request.id, true, function(info) {sendResponse(info);});
			} else if(request.type == "settrackloved") {
				setTrackLoved(request.id, request.title, request.artist);
				sendResponse({});
			}
		}
		
		function saveSettingsToLocalStorage() {
			window.localStorage.setItem("hidechat", settings.hidechat ? "true" : "false");
			window.localStorage.setItem("showuploader", settings.showuploader ? "true" : "false");
			window.localStorage.setItem("albumart", settings.albumart ? "true" : "false");
			
			window.localStorage.setItem("scrobble", settings.scrobble ? "true" : "false");
			window.localStorage.setItem("showscrobblestatus", settings.showscrobblestatus ? "true" : "false");
			window.localStorage.setItem("lastfmlink", settings.lastfmlink ? "true" : "false");
			window.localStorage.setItem("showlastfmlovebutton", settings.showlastfmlovebutton ? "true" : "false");
			
			if(!settings.scrobble && !settings.showlastfmlovebutton && lastfmSession) {
				lastfmSession = undefined;
			}
		}
		
		function loadSettingsFromLocalStorage() {
			settings = {};
			var hidechat = window.localStorage.getItem("hidechat");
			settings.hidechat = (hidechat && hidechat == "true");
			var showuploader = window.localStorage.getItem("showuploader");
			settings.showuploader = (!showuploader || showuploader == "true");
			var albumart = window.localStorage.getItem("albumart");
			settings.albumart = (!albumart || albumart == "true");
			
			var scrobble = window.localStorage.getItem("scrobble");
			settings.scrobble = (!scrobble || scrobble == "true");
			var lastfmlink = window.localStorage.getItem("lastfmlink");
			settings.lastfmlink = (!lastfmlink || lastfmlink == "true");
			var showscrobblestatus = window.localStorage.getItem("showscrobblestatus");
			settings.showscrobblestatus = (!showscrobblestatus || showscrobblestatus == "true");
			var showlastfmlovebutton = window.localStorage.getItem("showlastfmlovebutton");
			settings.showlastfmlovebutton = (!showlastfmlovebutton || showlastfmlovebutton == "true");
		}
		
		function lastFmLoginData(login) {
			lastfmUsername = login.username;
						
			lastfm.auth.getMobileSession({username: lastfmUsername, password: login.password}, {success: function(data){
				lastfmSession = data.session;
				if(currentTrack) {
					setNowPlaying(currentTrack);
				}
			}, error: function(code, message){
				console.log("Last.fm log in error: " + code + " - " + message);
			}});
		}
		
		function showLastfmLoginBox() {
			if((settings.scrobble || settings.showlastfmlovebutton) && lastfmSession == undefined) {
				chrome.tabs.getSelected(null, function(tab) {
				  chrome.tabs.sendRequest(tab.id, {type: "lastfmloginneeded", lastfmUsername: lastfmUsername}, function(response) {});
				});
			}
		}
		
		function scrobbleOldestScrobbleableTrack() {
			if(settings.scrobble && lastfmSession != undefined) {
				db.transaction(function(tx) {
					tx.executeSql('select id, artist, title, album, date from TRACK_PLAY where lastfm_status = ? order by date limit 1', [lastfmStatus.WAITING_FOR_SCROBBLING], function(tx2, rs) {
						if(rs.rows.length == 1) {
							var row = rs.rows.item(0);
							var timestamp = Math.round(parseInt(row["date"]) / 1000);
							lastfm.track.scrobble({track: row["title"], timestamp: timestamp, artist: row["artist"], album: row["album"]}, lastfmSession, {success: function(data){
								db.transaction(function(tx3) {
									tx3.executeSql('update TRACK_PLAY set lastfm_status = ? where id = ?', [lastfmStatus.SCROBBLED, row["id"]], ignore, sqlError);
									sendUpdatedTrackInfo(row["id"]);
								});
							}, error: function(code, message){
								console.log("Last.fm scrobble error: " + code + " - " + message);
							}});
						}
					}, sqlError);
				});
			}
		}
		
		function pulse() {
			showLastfmLoginBox();
			scrobbleOldestScrobbleableTrack();
		}
		
		function init() {
			chrome.extension.onRequest.addListener(processMessage);
			initDB();
			var storedLastfmUser = window.localStorage.getItem("lastfm_username");
			if(storedLastfmUser) {
				lastfmUsername = storedLastfmUser;
			}
			loadSettingsFromLocalStorage();
			setInterval(pulse, 5000);
		}
		
		init();
	</script>
</html>